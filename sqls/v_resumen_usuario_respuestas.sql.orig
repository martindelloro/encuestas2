<<<<<<< HEAD
-- DROP VIEW v_resumen_usuario_respuestas;

CREATE OR REPLACE VIEW v_resumen_usuario_respuestas AS 
 SELECT a.id AS encuesta_id, c.usuario_id, count(c.usuario_id) AS cantrespuestas, count(b.encuesta_id) AS totalpreguntas, count(c.usuario_id) / count(b.encuesta_id) * 100 AS porcentaje
   FROM encuestas a
   JOIN encuestas_preguntas b ON a.id = b.encuesta_id
   JOIN respuestas c ON b.pregunta_id = c.pregunta_id AND c.encuesta_id = a.id
  GROUP BY a.id, c.usuario_id
  ORDER BY c.usuario_id DESC;
=======
-- View: v_resumen_usuario_respuestas

-- DROP VIEW v_resumen_usuario_respuestas;

CREATE OR REPLACE VIEW v_resumen_usuario_respuestas AS 
 SELECT a.id AS encuesta_id,
    d.usuario_id,
    count(e.usuario_id) AS cantrespuestas,
    count(b.encuesta_id) AS totalpreguntas,
        CASE
            WHEN count(b.encuesta_id) > 0 THEN count(e.usuario_id) / count(b.encuesta_id) * 100
            ELSE 0::bigint
        END AS porcentaje
   FROM encuestas a
   LEFT JOIN encuestas_preguntas b ON a.id = b.encuesta_id
   LEFT JOIN encuestas_grupos c ON c.encuesta_id = a.id
   JOIN grupos_usuarios d ON c.grupo_id = d.grupo_id
   LEFT JOIN respuestas e ON b.pregunta_id = e.pregunta_id AND e.encuesta_id = a.id AND e.usuario_id = d.usuario_id
  GROUP BY a.id, d.usuario_id
  ORDER BY d.usuario_id DESC;
>>>>>>> e3d4cc815d8e1708660672a1877bcd909c0cbaa5

ALTER TABLE v_resumen_usuario_respuestas
  OWNER TO encuestas;